<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng bài mới - Game Mood</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="../css/new_post.css">
    <!-- Quill Editor CDN -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
</head>
<body>
    <div class="editor-header">
        <div class="title-thumbnail-group">
            <input type="text" id="title-input" placeholder="Tiêu đề bài viết">
            <input type="text" id="thumbnail-url-input" placeholder="Link ảnh thumbnail (URL)">
        </div>
        <button id="theme-toggle" class="btn btn-theme">
            <i class="fas fa-sun theme-icon-light"></i>
            <i class="fas fa-moon theme-icon-dark"></i>
        </button>
        <div class="header-buttons">
            <button id="add-post-btn">Đăng</button>
            <a href="../index.html"><button id="cancel-post-btn" type="button">Hủy bỏ</button></a>
        </div>
    </div>
    <div class="editor-container">
      <!-- Quill Toolbar -->
      <div id="toolbar-container">
        <span class="ql-formats">
          <select class="ql-header">
            <option selected></option>
            <option value="1">H1</option>
            <option value="2">H2</option>
            <option value="3">H3</option>
          </select>
          <button class="ql-bold"></button>
          <button class="ql-italic"></button>
          <button class="ql-underline"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-list" value="ordered"></button>
          <button class="ql-list" value="bullet"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-image"></button>
          <button class="ql-link"></button>
        </span>
      </div>
      <div id="editor"></div>
    </div>
    <script src="../js/switch_theme.js"></script>
    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script type="module">
        import { Blog, addBlog } from "../components/blogs.js";
        // Khởi tạo Quill editor
        const quill = new Quill('#editor', {
            modules: {
                toolbar: '#toolbar-container'
            },
            theme: 'snow'
        });

        // Sự kiện khi nhấn nút "Đăng" để đăng bài viết
        document.getElementById('add-post-btn').addEventListener('click', async function() {
            const title = document.getElementById('title-input').value;
            const thumbnail = document.getElementById('thumbnail-url-input').value; // Changed variable name for clarity
            const content = quill.root.innerHTML;

            if (title.trim() === "" || quill.getText().trim() === "") {
                alert("Vui lòng điền tiêu đề và nội dung bài viết.");
                return;
            }
            // Basic URL validation for thumbnail
            if (thumbnail.trim() !== "" && !/^https?:\/\/.+\..+/.test(thumbnail)) { // Use 'thumbnail' variable
                alert("Link ảnh thumbnail không hợp lệ. Vui lòng nhập URL hợp lệ.");
                return;
            }


            let email = "unknown";
            const currentUser = JSON.parse(localStorage.getItem("currentUser"))[0];
            if (currentUser && currentUser.email) {
                email = currentUser.email;
            }
            const post = Blog({
                title: title,
                content: content,
                postedBy: email,
                description: quill.getText().slice(0, 150),
                thumbnail: thumbnail.trim() // Changed property to 'thumbnail'
            });

            try {
                await addBlog(post);
                alert("Bài viết đã được đăng thành công!");
                window.location.href = './blogs.html'; 
            } catch (error) {
                alert("Đăng bài thất bại: " + error.message);
            }
        });
    </script>
</body>
</html>
